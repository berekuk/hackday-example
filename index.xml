#!/usr/bin/perl
# vim: ft=perl
# Copyright (c) 2009 Yandex.ru

use strict;
use warnings;

use CGI;
use CGI::Carp qw(fatalsToBrowser);
use Storable qw(retrieve);
use Template;
use Encode;

use lib '.';
use Util;

my $cgi = CGI->new();
$cgi->charset('utf-8');
print $cgi->header(-content => 'text/html');

my $xml = retrieve('/var/www/hackday/data/xml');

my $text = $cgi->param('text');
if ($text) {
    $xml->{rss} = rss($text);
    $xml->{rss_popular} = rss($text, { how => 'relev' });
    $text = decode_utf8($text);
}
$text ||= 'hackday';

my $template = Template->new(INCLUDE_PATH => '/var/www/hackday/tt', ENCODING => 'utf8');
$template->process('index.html', { text => $text, rss => $xml }) or die $template->error;

